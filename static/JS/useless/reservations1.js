// ============================
// üìë reservations.js all√©g√© - sans logique d'authentification
// ============================

// Table des mati√®res mise √† jour :
// 1. üöÄ Initialisation DOM & Pr√©remplissage
// 2. üîç Param√®tres URL & Avis
// 3. üè® Info H√¥tel + Carte
// 4. ‚≠ê Avis avec tri & pagination
// 5. üì° Chargement avis depuis API
// 6. üßæ R√©servation & redirection paiement
// 7. üìÖ Checkin / Checkout logique


// ============================
// 1. üöÄ Initialisation DOM
// ============================
document.addEventListener("DOMContentLoaded", function () {
    console.log("üöÄ reservations.js charg√© et DOM pr√™t !");

    // ‚úÖ Initialisation des variables touch√©es (avant toute utilisation)
    let emailTouched = false;
    let phoneTouched = false;

    // üëâ Pr√©remplissage du formulaire si l'utilisateur est connect√©
    const safeSet = (id, value) => {
        const field = document.getElementById(id);
        if (field && value) field.value = value;
    };

    safeSet("first-name", localStorage.getItem("first_name"));
    safeSet("user_name", localStorage.getItem("name"));
    safeSet("email", localStorage.getItem("email"));

    // üîÅ Nettoyage du t√©l√©phone pour n'autoriser que les chiffres (pas de +33)
    const rawPhone = localStorage.getItem("phone");
    const cleanPhone = rawPhone?.replace(/[^0-9]/g, "");  // enl√®ve +, espaces, etc.
    safeSet("phone", cleanPhone);

    const emailField = document.getElementById("email");
    const phoneField = document.getElementById("phone");
    const reservationForm = document.getElementById("reservation-form");
    const submitBtn = document.getElementById("submit-btn");

    // ‚úÖ S√©lection des divs d'erreur existantes (d√©j√† dans le HTML)
    const emailError = document.getElementById("reservation-email-error");
    const phoneError = document.getElementById("reservation-phone-error");

    // ‚úÖ Si d√©j√† remplis, on consid√®re les champs comme "touch√©s"
    if (emailField.value.trim() !== "") emailTouched = true;
    if (phoneField.value.trim() !== "") phoneTouched = true;

    function validateEmailPhone() {
        const email = emailField.value.trim();
        const phone = phoneField.value.trim();

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^\+?[0-9\s\-()]{7,}$/;

        const emailValid = emailRegex.test(email);
        const phoneValid = phoneRegex.test(phone);

        const emailEmpty = email === "";
        const phoneEmpty = phone === "";

        // ‚úâÔ∏è Email
        if (emailTouched) {
            if (emailEmpty) {
                emailError.textContent = "‚ùå Le champ email est obligatoire.";
                emailError.classList.add("visible");
            } else if (!emailValid) {
                emailError.textContent = "‚ùå Veuillez entrer une adresse email valide.";
                emailError.classList.add("visible");
            } else {
                emailError.textContent = "";
                emailError.classList.remove("visible");
            }
        }

        // üìû T√©l√©phone
        if (phoneTouched) {
            if (phoneEmpty) {
                phoneError.textContent = "‚ùå Le champ t√©l√©phone est obligatoire.";
                phoneError.classList.add("visible");
            } else if (!phoneValid) {
                phoneError.textContent = "‚ùå Num√©ro invalide. Exemple : +33 6 12 34 56 78";
                phoneError.classList.add("visible");
            } else {
                phoneError.textContent = "";
                phoneError.classList.remove("visible");
            }
        }

        // üé® Mise √† jour des classes CSS
        emailField.classList.toggle("invalid", emailTouched && (!emailValid || emailEmpty));
        phoneField.classList.toggle("invalid", phoneTouched && (!phoneValid || phoneEmpty));

        emailField.classList.toggle("valid", emailTouched && emailValid);
        phoneField.classList.toggle("valid", phoneTouched && phoneValid);

        submitBtn.disabled = !(emailValid && phoneValid);
    }

    // ‚úÖ √âv√©nements sur les champs
    emailField.addEventListener("input", () => {
        emailTouched = true;
        validateEmailPhone();
    });

    phoneField.addEventListener("input", () => {
        phoneTouched = true;
        validateEmailPhone();
    });

    // ‚úÖ Lancer la validation imm√©diatement
    validateEmailPhone();


     // =====================================
    // üîç 6. R√©cup√©ration des Param√®tres URL
    // =====================================
    const params = new URLSearchParams(window.location.search);
    console.log("üîç Param√®tres r√©cup√©r√©s :", Object.fromEntries(params.entries()));

    const reviewsJSON = params.get("reviews");
    let reviews = [];

    try {
        reviews = reviewsJSON ? JSON.parse(decodeURIComponent(reviewsJSON)) : [];
    } catch (error) {
        console.error("‚ùå Erreur de parsing des avis :", error);
        reviews = [];
    }

    console.log("üîç Reviews apr√®s d√©codage :", reviews);

    // =====================================
    // üìù 7. Affichage Initial des Avis
    // =====================================
    setTimeout(() => {
        displayReviews(reviews);
    }, 500);

    // =====================================
    // üè® 8. Chargement et Affichage de l'H√¥tel
    // =====================================
    const hotel = getHotelData(params);
    console.log("‚úÖ H√¥tel charg√© :", hotel);
    updateHotelInfo(hotel);

    // =====================================
    // üó∫Ô∏è 9. Initialisation Carte Interactive
    // =====================================
    if (!window.map) {
        console.log("üó∫Ô∏è Cr√©ation de la carte...");
        createMap(hotel.latitude, hotel.longitude);
    } else {
        window.map.setView([hotel.latitude, hotel.longitude], 12);
    }

    addHotelMarker(hotel);

    // =====================================
    // üì¢ 10. Chargement Dynamique des Avis
    // =====================================
    const hotelId = params.get("hotel_id");
    console.log("üîç `hotel_id` r√©cup√©r√© dans reservations.js :", hotelId);
    if (!reviews.length && hotelId) {
        console.log(`üìù Chargement des avis via l'API pour l'h√¥tel ID: ${hotelId}`);
        loadReviews(hotelId, "date");
    }
    
    // =====================================
    // üè® 11. Chargement de Tous les H√¥tels
    // =====================================
    loadAllHotels();

    // =====================================
    // üßπ 12. Ajout des √âcouteurs de Tri Avis
    // =====================================
    setTimeout(() => {
        console.log("‚è≥ V√©rification apr√®s chargement des √©l√©ments...");
    
        let sortByDateBtn = document.getElementById("sort-by-date");
        let sortByRatingBtn = document.getElementById("sort-by-rating");
        let sortByNameBtn = document.getElementById("sort-by-name");
        let paginationContainer = document.querySelector(".review-pagination");
    
        if (sortByDateBtn) {
            sortByDateBtn.addEventListener("click", () => sortReviews(reviews, "date"));
        }
    
        if (sortByRatingBtn) {
            sortByRatingBtn.addEventListener("click", () => sortReviews(reviews, "rating"));
        }
    
        if (sortByNameBtn) {
            sortByNameBtn.addEventListener("click", () => sortReviews(reviews, "name"));
        }
    }, 1000);
});  


// ============================================================
// üîÉ 13. Tri des Avis selon Crit√®re
// ============================================================
function sortReviews(reviews, criterion) {
    if (criterion === "date") {
        reviews.sort((a, b) => new Date(b.date_posted) - new Date(a.date_posted));
    } else if (criterion === "rating") {
        reviews.sort((a, b) => b.rating - a.rating);
    } else if (criterion === "name") {
        reviews.sort((a, b) => a.first_name.localeCompare(b.first_name));
    }
    currentPage = 1;
    displayReviews(reviews);
}


// ============================================================
// üõéÔ∏è 14. R√©cup√©ration des Donn√©es H√¥tel depuis URL
// ============================================================
function getHotelData(params) {
    let imagePath = params.get("image");
    if (!imagePath || imagePath === "null") imagePath = "/static/Image/default.jpg";
    else if (!imagePath.startsWith("http") && !imagePath.startsWith("/static/Image/")) imagePath = `/static/Image/${imagePath}`;

    let hotelLat = parseFloat(params.get("lat")) || 48.8566;
    let hotelLng = parseFloat(params.get("lng")) || 2.3522;

    return {
        id: params.get("hotel_id") || null,
        name: params.get("name") || "Nom de l'h√¥tel",
        stars: parseInt(params.get("stars")) || 0,
        rating: params.get("rating") || "N/A",
        address: params.get("address") && params.get("address") !== "null" ? params.get("address") : "Adresse inconnue",
        image: imagePath,
        description: params.get("description") && params.get("description") !== "null" ? params.get("description") : "Aucune description disponible",
        equipments: params.get("equipments") ? decodeURIComponent(params.get("equipments")).split(",").map(e => e.trim()) : [],
        latitude: hotelLat,
        longitude: hotelLng
    };
}


// ============================================================
// üó∫Ô∏è 15. Cr√©ation de la Carte Leaflet
// ============================================================
function createMap(lat, lng) {
    if (window.map) window.map.remove();
    
    console.log("üó∫Ô∏è Initialisation de la carte √† :", lat, lng);
    window.map = L.map('hotel-map').setView([lat, lng], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
    }).addTo(window.map);
    console.log("‚úÖ Carte cr√©√©e avec succ√®s !");
}


// ============================================================
// üìç 16. Ajout du Marqueur de l'H√¥tel sur la Carte
// ============================================================
function addHotelMarker(hotel) {
    if (!window.map) {
        console.error("‚ùå Impossible d'ajouter le marqueur, la carte n'existe pas encore !");
        return;
    }
    window.markers = window.markers || [];

    window.markers = window.markers.filter(marker => {
        if (marker.getLatLng().equals([hotel.latitude, hotel.longitude])) {
            window.map.removeLayer(marker);
            return false;
        }
        return true;
    });

    let marker = L.marker([hotel.latitude, hotel.longitude])
        .addTo(window.map)
        .bindPopup(`<strong>${hotel.name}</strong><br>${hotel.address}`)
        .on("click", function () {
            console.log(`üè® H√¥tel s√©lectionn√© : ${hotel.name}`);
            if (!hotel.image || hotel.image === "null") {
                hotel.image = "/static/Image/default.jpg";
            }            
            updateHotelInfo(hotel);
            if (hotel.id) {
                console.log(`üìù Rechargement des avis pour l‚Äôh√¥tel ID : ${hotel.id}`);
                loadReviews(hotel.id, "date");
            }
        });
        
    
    window.markers.push(marker);
}


// ============================================================
// üè® 17. Chargement de Tous les H√¥tels (depuis API)
// ============================================================
function loadAllHotels() {
    fetch("/hotels")
        .then(response => response.json())
        .then(hotels => {
            console.log("üìå Liste des h√¥tels r√©cup√©r√©s :", hotels);
            if (!hotels.length) return console.warn("‚ö†Ô∏è Aucun h√¥tel trouv√©.");

            window.allHotels = hotels;
            hotels.forEach((h, index) => {
                setTimeout(() => {
                    if (h.latitude && h.longitude) {
                        addHotelMarker({
                            id: h.id,
                            name: h.name,
                            stars: h.stars,
                            rating: h.rating,
                            address: h.address,
                            image: h.image || "/static/Image/default.jpg", 
                            description: h.description,
                            equipments: h.equipments || [],
                            latitude: h.latitude,
                            longitude: h.longitude
                        });
                    }
                }, index * 50); // üëà cette parenth√®se √©tait mal plac√©e dans ta version
            });
        })
        .catch(error => console.error("‚ùå Erreur lors du chargement des h√¥tels :", error));
}


// ============================================================
// üîÑ 18. Mise √† jour de l‚ÄôInfo H√¥tel (HTML + Carte)
// ============================================================
function updateHotelInfo(hotel) {
    console.log(`üîÑ Mise √† jour de l'h√¥tel s√©lectionn√© : ${hotel.name}`);
    console.log("üìç Adresse re√ßue :", hotel.address);

    const imageUrl = hotel.image && hotel.image !== "null"
    ? hotel.image
    : "/static/Image/default.jpg";

    console.log("üñºÔ∏è Image finale utilis√©e :", imageUrl);

    const layoutContainer = document.querySelector(".layout-container");
    if (!layoutContainer) {
        console.error("‚ùå ERREUR: La div .layout-container n'existe pas !");
        return;
    }

    // Si les sections carte et avis existent d√©j√†, on les extrait pour les r√©ins√©rer apr√®s
    const existingMapAndReviews = document.querySelector(".map-reviews-container");

    // üìå Dictionnaire des √©quipements avec emojis
    const equipmentIcons = {
        "Parking": "üöó",
        "Restaurant": "üçΩÔ∏è",
        "Piscine": "üèä",
        "Animaux admis": "üêæ",
        "Salle de sport": "üèãÔ∏è",
        "Spa": "üíÜ",
        "Wi-Fi gratuit": "üì∂",
        "Climatisation": "‚ùÑÔ∏è",
        "Borne recharge": "‚ö°",
        "Acc√®s PMR": "‚ôø",
        "Machine √† laver": "üß∫",
        "Kitchenette": "üç≥"
    };

    layoutContainer.innerHTML = `
        <div class="hotel-info-container">
            <h1>${hotel.name} <span class="hotel-stars">${'‚≠ê'.repeat(hotel.stars)}</span></h1>
            <p class="hotel-address">üìç ${hotel.address}</p>
            <div class="hotel-image-container">
                <img src="${imageUrl}" alt="Photo de l'h√¥tel">
            </div>
            <div class="hotel-equipments">
                <h3>√âquipements</h3>
                <div class="equipments-grid">
                    ${hotel.equipments.length > 0 
                        ? hotel.equipments.map(e => 
                            `<div class="equipment-item"><span>${equipmentIcons[e] || "‚ùì"}</span> ${e}</div>`
                        ).join("") 
                        : "<p>Aucun √©quipement disponible.</p>"
                    }
                </div>
            </div>
            <div class="hotel-description">
                <h3>Description</h3>
                <p>${hotel.description}</p>
            </div>
        </div>
    `;

    // On r√©ins√®re la carte et les avis s'ils existaient d√©j√†
    if (existingMapAndReviews) {
        layoutContainer.appendChild(existingMapAndReviews);
    }

    // üîÅ Mise √† jour de la carte (sans la recr√©er)
    if (window.map) {
        window.map.setView([hotel.latitude, hotel.longitude], 12);

        if (window.selectedMarker) {
            window.map.removeLayer(window.selectedMarker);
        }

        window.selectedMarker = L.marker([hotel.latitude, hotel.longitude])
            .addTo(window.map)
            .bindPopup(`<strong>${hotel.name}</strong><br>${hotel.address}`)
            .openPopup();
    } else {
        createMap(hotel.latitude, hotel.longitude);
        window.selectedMarker = L.marker([hotel.latitude, hotel.longitude])
            .addTo(window.map)
            .bindPopup(`<strong>${hotel.name}</strong><br>${hotel.address}`)
            .openPopup();
    }

        
    addHotelMarker(hotel);
}

const reviewsPerPage = 10;
let currentPage = 1;


// ============================================================
// ‚≠ê 19. Affichage des Avis Clients + Tri + Pagination
// ============================================================
function displayReviews(reviews) {
    console.log("üìù Affichage des avis dans #reviews-list :", reviews);
    
    const reviewsContainer = document.getElementById("reviews-list");
    let paginationContainer = document.querySelector(".review-pagination");
    let filtersContainer = document.querySelector(".review-filters");

    if (!reviewsContainer) {
        console.error("‚ùå ERREUR : L'√©l√©ment #reviews-list est introuvable !");
        return;
    }

    reviewsContainer.innerHTML = "";
 
    if (!paginationContainer) {
        console.warn("‚ö†Ô∏è .review-pagination n'existe pas encore, cr√©ation manuelle...");
        paginationContainer = document.createElement("div");
        paginationContainer.classList.add("review-pagination");
        document.querySelector(".reviews-section").appendChild(paginationContainer);
    } else {
        paginationContainer.innerHTML = ""; // Nettoyage des anciens boutons
    }

    if (!filtersContainer) {
        console.warn("‚ö†Ô∏è .review-filters n'existe pas encore, cr√©ation manuelle...");
        filtersContainer = document.createElement("div");
        filtersContainer.classList.add("review-filters");
        document.querySelector(".reviews-section").insertBefore(filtersContainer, reviewsContainer);

        filtersContainer.innerHTML = `
        <button id="sort-by-date">üìÖ Trier par date</button>
        <button id="sort-by-rating">‚≠ê Trier par note</button>
        <button id="sort-by-name">üî§ Trier par nom</button>
        `;
    }
    
    if (reviews.length === 0) {
        console.warn("‚ö†Ô∏è Aucun avis re√ßu, affichage du message par d√©faut.");
        reviewsContainer.innerHTML = "<p>Aucun avis pour le moment.</p>";
        return;
    }

    console.log("üìå Nombre total d'avis √† afficher :", reviews.length);

    // üé® Affichage des avis en 2 colonnes
    let reviewGrid = document.createElement("div");
    reviewGrid.classList.add("review-grid");

    // üìå D√©coupe des avis par page
    const start = (currentPage - 1) * reviewsPerPage;
    const end = start + reviewsPerPage;
    const reviewsToDisplay = reviews.slice(start, end);

    if (reviewsToDisplay.length === 0) {
        console.warn("‚ö†Ô∏è Aucun avis √† afficher sur cette page !");
    }

    try {
        reviewsToDisplay.forEach((review) => {
            const reviewElement = document.createElement("div");
            reviewElement.className = "review-item";
            reviewElement.innerHTML = `
                <div class="review-header">
                    <strong>${review.first_name} ${review.name || ""}</strong> - ${formatDate(review.date_posted)} 
                    <span class="review-rating">‚≠ê ${review.rating} / 10</span>
                </div>
                <p class="review-comment">${review.comment}</p>
                <hr>
            `;
            reviewGrid.appendChild(reviewElement);
        });
    } catch (error) {
        console.error("‚ùå Erreur lors de l'affichage des avis :", error);
    }

    console.log("üìå V√©rification avant d'ajouter les avis au DOM :", reviewGrid);
    reviewsContainer.appendChild(reviewGrid);

    // üîÑ Gestion de la pagination
    let totalPages = Math.ceil(reviews.length / reviewsPerPage);
    if (totalPages > 1) {
        paginationContainer.innerHTML = ""; // Nettoyage des anciens boutons
        for (let i = 1; i <= totalPages; i++) {
            let pageButton = document.createElement("button");
            pageButton.textContent = i;
            if (currentPage === i) {
                pageButton.classList.add("active");
            }
            pageButton.addEventListener("click", function () {
                currentPage = i;
                displayReviews(reviews);
            });
            paginationContainer.appendChild(pageButton);
        }
    }
    // üõ† Ajout des √©v√©nements pour le tri (√©vite les doublons)
    document.getElementById("sort-by-date").addEventListener("click", () => {
        reviews.sort((a, b) => new Date(b.date_posted) - new Date(a.date_posted));
        currentPage = 1;
        displayReviews(reviews);
    });

    document.getElementById("sort-by-rating").addEventListener("click", () => {
        reviews.sort((a, b) => b.rating - a.rating);
        currentPage = 1;
        displayReviews(reviews);
    });

    document.getElementById("sort-by-name").addEventListener("click", () => {
        reviews.sort((a, b) => a.first_name.localeCompare(b.first_name));
        currentPage = 1;
        displayReviews(reviews);
    });

    console.log("‚úÖ Avis mis √† jour avec tri et pagination !");
}


// ============================================================
// üì° 20. Chargement des Avis depuis API /get_reviews
// ============================================================
// üì¢ Fonction pour charger les avis depuis l'API
function loadReviews(hotelId, sortBy) {
    console.log(`üîç Tentative de chargement des avis pour l'h√¥tel ID: ${hotelId} avec tri: ${sortBy}`);

    fetch(`/get_reviews?hotel_id=${hotelId}&sort_by=${sortBy}`)
        .then(response => response.json())
        .then(reviews => {
            console.log("‚úÖ Avis r√©cup√©r√©s :", reviews);
            currentPage = 1; // R√©initialiser √† la premi√®re page apr√®s le tri
            displayReviews(reviews);

            // üì¢ Re-ajouter les √©v√©nements de tri apr√®s un rechargement des avis
            document.getElementById("sort-by-date")?.addEventListener("click", () => {
                reviews.sort((a, b) => new Date(b.date_posted) - new Date(a.date_posted));
                currentPage = 1; // Revenir √† la premi√®re page apr√®s le tri
                displayReviews(reviews);
            });

            document.getElementById("sort-by-rating")?.addEventListener("click", () => {
                reviews.sort((a, b) => b.rating - a.rating);
                currentPage = 1; // Revenir √† la premi√®re page apr√®s le tri
                displayReviews(reviews);
            });

        })
        .catch(error => console.error("‚ùå Erreur lors du chargement des avis :", error));
}


// ============================================================
// üìÖ 21. Formattage des Dates des Avis
// ============================================================
function formatDate(dateString) {
    console.log("üìå Date re√ßue :", dateString, "| Type :", typeof dateString);

    if (!dateString) return "Date inconnue";

    // Forcer le format correct en ajoutant 'T00:00:00Z' si n√©cessaire
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
        dateString += "T00:00:00Z";
    }

    let date = new Date(dateString);

    if (isNaN(date.getTime())) {
        console.error("‚ùå Date invalide :", dateString);
        return "Date inconnue";
    }

    return date.toLocaleDateString("fr-FR", {
        weekday: "long",  // ex: lundi
        day: "2-digit",
        month: "long",    // ex: mars
        year: "numeric"
    });
}


// ============================================================
// üìã 22. Gestion du Formulaire de R√©servation et Paiement
// ============================================================
// Debut du chemin vers paiement.js
document.addEventListener("DOMContentLoaded", function () {
    const reservationForm = document.getElementById("reservation-form");
    const adultsInput = document.getElementById("adults1");
    const childrenInput = document.getElementById("children1");
    const totalGuestsDisplay = document.getElementById("total-guests");
    const guestsInput = document.getElementById("guests");
    const errorMessage = document.getElementById("error-message");

    // ‚úÖ V√©rifier que les √©l√©ments existent avant d'ajouter des √©v√©nements
    if (!adultsInput || !childrenInput || !guestsInput || !totalGuestsDisplay) {
        console.error("‚ùå Un des champs de s√©lection des voyageurs est manquant !");
        return;
    }

    // ‚úÖ Fonction pour calculer le nombre total de voyageurs
    function updateTotalGuests() {
        console.log("üîÑ updateTotalGuests() appel√©e !");
        
        let adults = parseInt(adultsInput.value) || 0;
        let children = parseInt(childrenInput.value) || 0;
        let total = adults + children;

        console.log(`üîÑ AVANT mise √† jour: Total = ${totalGuestsDisplay.textContent}`);
        console.log(`üë® Adultes: ${adults}, üë∂ Enfants: ${children}, üë• Total Calcul√©: ${total}`);

        // ‚úÖ V√©rifier que errorMessage existe avant de modifier `.style`
        if (errorMessage) {
            if (total > 6 || adults > 4 || children > 2) {
                errorMessage.style.display = "block";
                errorMessage.textContent = "‚ùå Maximum 4 adultes et 2 enfants (6 personnes au total)";
                guestsInput.setCustomValidity("Le nombre total de voyageurs ne peut pas d√©passer 6.");
            } else {
                errorMessage.style.display = "none";
                guestsInput.setCustomValidity("");
            }
        }

        // ‚úÖ V√©rification avant mise √† jour
        if (totalGuestsDisplay) {
            console.log(`üîÑ AVANT mise √† jour: ${totalGuestsDisplay.textContent}`);
            totalGuestsDisplay.textContent = total;
            guestsInput.value = total;
            console.log(`‚úÖ APR√àS mise √† jour: ${totalGuestsDisplay.textContent}`);
        } else {
            console.warn("‚ö†Ô∏è L'√©l√©ment totalGuestsDisplay est introuvable, mise √† jour ignor√©e.");
        }
    } 

    // ‚úÖ Ajout des √©couteurs d'√©v√©nements pour mettre √† jour automatiquement
    adultsInput.addEventListener("input", function () {
        console.log("üë® Modification du nombre d'adultes d√©tect√©e !");
        updateTotalGuests();
    });

    childrenInput.addEventListener("input", function () {
        console.log("üë∂ Modification du nombre d'enfants d√©tect√©e !");
        updateTotalGuests();
    });

    updateTotalGuests(); // Initialisation au chargement de la page

    // ‚úÖ Gestion de la soumission du formulaire
    if (reservationForm) {
        reservationForm.addEventListener("submit", async function (event) {
            event.preventDefault(); // ‚úÖ Emp√™che le rechargement de la page

            console.log("üîç Soumission du formulaire d√©tect√©e...");

            const params = new URLSearchParams(window.location.search);
            let hotelId = params.get("hotel_id"); // ‚úÖ V√©rification correcte de hotel_id
            let checkin = document.getElementById("checkin")?.value;
            let checkout = document.getElementById("checkout")?.value;
            let adults = parseInt(adultsInput?.value) || 0;
            let children = parseInt(childrenInput?.value) || 0;
            let guests = adults + children; // ‚úÖ V√©rification du total
            const imageUrl = params.get("image_url") || params.get("image") || "/static/Image/default.jpg";

            if (!hotelId) {
                console.error("‚ùå `hotel_id` invalide :", hotelId);
                alert("‚ùå Aucun h√¥tel s√©lectionn√©.");
                return;
            }

            if (isNaN(guests) || guests <= 0) {
                console.error("‚ùå Probl√®me avec la valeur de guests, r√©initialisation √† 1.");
                guests = 1; // Valeur par d√©faut si vide
            }

            // ‚úÖ V√©rification des limites d'invit√©s
            if (guests > 6 || adults > 4 || children > 2) {
                alert("‚ùå Nombre de voyageurs incorrect. Maximum : 4 adultes et 2 enfants.");
                return;
            }

            console.log(`‚úÖ Nombre total de voyageurs : ${guests} (Adultes: ${adults}, Enfants: ${children})`);

            const reservationData = {
                hotel_id: hotelId,
                checkin,
                checkout,
                guests,
                adults,
                children,
                gender: document.getElementById("gender")?.value || "",
                first_name: document.getElementById("first-name")?.value || "",
                user_name: document.getElementById("user_name")?.value || "",
                email: document.getElementById("email")?.value || "",
                phone: document.getElementById("phone")?.value || "",
                stripe_customer_id: localStorage.getItem("stripe_customer_id") || "",
                user_id: localStorage.getItem("user_id") || "",
                total_price: parseFloat(localStorage.getItem("total_price")) || 0
            };

            const stripe_customer_id = localStorage.getItem("stripe_customer_id");
            if (stripe_customer_id) {
                reservationData.stripe_customer_id = stripe_customer_id;
            }

            // üîê Ajout du user_id si connect√©
            const userId = localStorage.getItem("user_id");

            if (!userId) {
            alert("Utilisateur non connect√©.");
            return;
            }

            reservationData.user_id = userId;

            const paiementUrl = `paiement?hotel_id=${encodeURIComponent(hotelId)}&checkin=${encodeURIComponent(checkin)}&checkout=${encodeURIComponent(checkout)}&guests=${encodeURIComponent(guests)}&adults=${encodeURIComponent(adults)}&children=${encodeURIComponent(children)}&gender=${encodeURIComponent(reservationData.gender)}&first_name=${encodeURIComponent(reservationData.first_name)}&user_name=${encodeURIComponent(reservationData.user_name)}&email=${encodeURIComponent(reservationData.email)}&phone=${encodeURIComponent(reservationData.phone)}&image_url=${encodeURIComponent(imageUrl)}`;

            console.log("üîÑ Redirection vers :", paiementUrl);
            window.location.href = paiementUrl;
        }); 
    } 
}); 

// ============================================================
// ‚úçÔ∏è 23. Pr√©remplissage du Formulaire Utilisateur Connect√©
// ============================================================
function prefillReservationForm() {
    const firstName = localStorage.getItem("first_name");
    const name = localStorage.getItem("name");
    const email = localStorage.getItem("email");
    const phone = localStorage.getItem("phone");

    if (firstName) {
        document.getElementById("first-name").value = firstName;
    }
    if (name) {
        document.getElementById("user_name").value = name;
    }
    if (email) {
        document.getElementById("email").value = email;
    }
    if (phone) {
        document.getElementById("phone").value = phone;
    }
}

// =====================================
// üìÖ 24. Liaison Date d'arriv√©e / d√©part avec message doux
// =====================================
const checkinInput = document.getElementById("checkin");
const checkoutInput = document.getElementById("checkout");
const checkoutWarning = document.getElementById("checkout-warning");

if (checkinInput && checkoutInput && checkoutWarning) {
    checkinInput.addEventListener("change", () => {
        const checkinDate = new Date(checkinInput.value);
        if (isNaN(checkinDate.getTime())) return;

        const nextDay = new Date(checkinDate);
        nextDay.setDate(checkinDate.getDate() + 1);
        const formatted = nextDay.toISOString().split("T")[0];

        // Appliquer la nouvelle date min
        checkoutInput.min = formatted;

        // Si checkout est ant√©rieur, on vide et affiche un message
        if (checkoutInput.value && checkoutInput.value < formatted) {
            checkoutInput.value = "";
            checkoutWarning.style.display = "inline";
        } else {
            checkoutWarning.style.display = "none";
        }
    });

    // Cacher l'avertissement si l'utilisateur change manuellement
    checkoutInput.addEventListener("change", () => {
        if (checkoutInput.value >= checkoutInput.min) {
            checkoutWarning.style.display = "none";
        }
    });
}
